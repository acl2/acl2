(IN-PACKAGE "RTL")

(INCLUDE-BOOK "rtl/rel11/lib/rac" :DIR :SYSTEM)

(SET-IGNORE-OK T)

(SET-IRRELEVANT-FORMALS-OK T)

(DEFUND COMPRESS (PP0 PP1 PP2 PP3 PP4 PP5 PP6 PP7)
  (LET* ((L0PP0 (LOGXOR (LOGXOR PP0 PP1) PP2))
         (L0PP1 (BITS (ASH (LOGIOR (LOGIOR (LOGAND PP0 PP1)
                                           (LOGAND PP0 PP2))
                                   (LOGAND PP1 PP2))
                           1)
                      15 0))
         (L0PP2 (LOGXOR (LOGXOR PP3 PP4) PP5))
         (L0PP3 (BITS (ASH (LOGIOR (LOGIOR (LOGAND PP3 PP4)
                                           (LOGAND PP3 PP5))
                                   (LOGAND PP4 PP5))
                           1)
                      15 0))
         (L0PP4 PP6)
         (L0PP5 PP7)
         (L1PP0 (LOGXOR (LOGXOR L0PP0 L0PP1) L0PP2))
         (L1PP1 (BITS (ASH (LOGIOR (LOGIOR (LOGAND L0PP0 L0PP1)
                                           (LOGAND L0PP0 L0PP2))
                                   (LOGAND L0PP1 L0PP2))
                           1)
                      15 0))
         (L1PP2 (LOGXOR (LOGXOR L0PP3 L0PP4) L0PP5))
         (L1PP3 (BITS (ASH (LOGIOR (LOGIOR (LOGAND L0PP3 L0PP4)
                                           (LOGAND L0PP3 L0PP5))
                                   (LOGAND L0PP4 L0PP5))
                           1)
                      15 0))
         (L2PP0 (LOGXOR (LOGXOR L1PP0 L1PP1) L1PP2))
         (L2PP1 (BITS (ASH (LOGIOR (LOGIOR (LOGAND L1PP0 L1PP1)
                                           (LOGAND L1PP0 L1PP2))
                                   (LOGAND L1PP1 L1PP2))
                           1)
                      15 0))
         (L2PP2 L1PP3)
         (L3PP0 (LOGXOR (LOGXOR L2PP0 L2PP1) L2PP2))
         (L3PP1 (BITS (ASH (LOGIOR (LOGIOR (LOGAND L2PP0 L2PP1)
                                           (LOGAND L2PP0 L2PP2))
                                   (LOGAND L2PP1 L2PP2))
                           1)
                      15 0)))
    (BITS (+ L3PP0 L3PP1) 15 0)))

(DEFUND GENPP-LOOP-0 (I A B PP)
  (DECLARE (XARGS :MEASURE (NFIX (- 8 I))))
  (IF (AND (INTEGERP I) (< I 8))
      (LET* ((PP (AS I 0 PP))
             (PP (AS I
                     (SETBITS (AG I PP)
                              16 (+ I (- 8 1))
                              I (IF1 (BITN A I) B 0))
                     PP)))
        (GENPP-LOOP-0 (+ I 1) A B PP))
    PP))

(DEFUND GENPP (A B)
  (LET ((PP NIL))
    (GENPP-LOOP-0 0 A B PP)))

(DEFUND COMPUTEPROD (A B)
  (LET ((PP (GENPP A B)))
    (COMPRESS (AG 0 PP)
              (AG 1 PP)
              (AG 2 PP)
              (AG 3 PP)
              (AG 4 PP)
              (AG 5 PP)
              (AG 6 PP)
              (AG 7 PP))))
