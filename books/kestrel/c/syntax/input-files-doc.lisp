; C Library
;
; Copyright (C) 2026 Kestrel Institute (http://www.kestrel.edu)
;
; License: A 3-clause BSD license. See the LICENSE file distributed with ACL2.
;
; Author: Alessandro Coglio (www.alessandrocoglio.info)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(in-package "C$")

(include-book "kestrel/event-macros/xdoc-constructors" :dir :system)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(defxdoc input-files

  :parents (syntax-for-tools)

  :short "Read C files from the file system into an ACL2 representation."

  :long

  (xdoc::topstring

   ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

   (xdoc::evmac-section-intro

    (xdoc::p
     "In the name of this macro,
      @('input') is best read as a verb:
      the macro inputs files into ACL2.")

    (xdoc::p
     "This macro takes as input a list of file paths
      (which must contain C code),
      reads those files from the file system,
      and performs a user-specified level of processing on them,
      yielding a representation in ACL2 of that C code.
      This representation can be further processed,
      e.g. to perform code transformations,
      after which the macro @(tsee output-files)
      can be used to write the transformed code to the file system.")

    (xdoc::p
     "The (non-event) macro @(tsee input-files-prog) provides
      a programmatic interface to the functionality of @('input-files')."))

   ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

   (xdoc::evmac-section-form

    (xdoc::codeblock
     "(input-files :files           ...  ; required, no default"
     "             :base-dir        ...  ; default \".\""
     "             :preprocess      ...  ; default nil"
     "             :preprocess-args ...  ; default nil"
     "             :include-dirs    ...  ; default nil"
     "             :process         ...  ; default :validate"
     "             :const           ...  ; required, no default"
     "             :keep-going      ...  ; default nil"
     "             :ienv            ...  ; default (ienv-default)"
     "  )"))

   ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

   (xdoc::evmac-section-inputs

    (xdoc::desc
     "@(':files') &mdash; required, no default"
     (xdoc::p
      "Term evaluating to a list of one or more file paths
       that specify the files to be read.")
     (xdoc::p
      "Each file path must be a string.")
     (xdoc::p
      "These paths are relative to
       the path specified by the @(':base-dir') input."))

    (xdoc::desc
     "@(':base-dir') &mdash; default @('\".\"')"
     (xdoc::p
      "Base directory,
       i.e. path that the file paths in @(':files') are relative to.")
     (xdoc::p
      "This must be a non-empty string that is a valid path name in the system.
       It may or may not end with a slash.
       A non-absolute path is relative to
       the connected book directory (see @(tsee cbd)).
       In particular, the @('\".\"') path (which is the default)
       specifies the connected book directory."))

    (xdoc::desc
     "@(':preprocess') &mdash; default @('nil')"
     (xdoc::p
      "Specifies the preprocessor to use, if any,
       on the files specified by the @(':files') and @(':base-dir') inputs.")
     (xdoc::p
      "This input must be one of the following:")
     (xdoc::ul
      (xdoc::li
       "@('nil') (the default),
        in which case no preprocessing is done.
        In this case, the files must be already in preprocessed form,
        or at least in the form that would be generated by
        the preprocessor provided with this ACL2 library
        (see the @(':internal') option below).")
      (xdoc::li
       "A string,
        which names the preprocessor to use,
        which must be in the current system path for executables.")
      (xdoc::li
       "@(':auto'),
        which implicitly names the preprocessor @('\"gcc\"'),
        which must be in the current system path for executables.")
      (xdoc::li
       "@(':internal'),
        which specifies the preprocessor provided by this ACL2 library.
        This preprocessor is still experimental;
        if it does not give the expected results,
        use an external preprocessor by providing a different option."))
     (xdoc::p
      "The preprocessing (if this input is not @('nil')),
       is performed via the @(tsee preprocess-file) tool."))

    (xdoc::desc
     "@(':preprocess-args') &mdash; default @('nil')"
     (xdoc::p
      "Specifies arguments to pass to the external preprocessor.")
     (xdoc::p
      "This must evaluate to a list of strings
       or to an omap from strings to lists of strings.")
     (xdoc::p
      "If @(':preprocess') is @('nil') or @(':internal'),
       the @(':preprocess-args') input must evaluate to @('nil').")
     (xdoc::p
      "If @(':preprocess') is not @('nil') or @(':internal'),
       the input files are preprocessed using an external preprocessor.
       For each file, we provide the @('-E') flag to that preprocessor,
       as well as some instantiation of the @('-std=') flag.
       This latter flag is based on the @('version') field of the "
      (xdoc::seetopic "implementation-environments"
                      "implementation environment")
       ", as indicated by the following table.")
     (xdoc::table_
      (xdoc::tr (xdoc::th "@(see c::Version)")
                (xdoc::th "Standard Flag"))
      (xdoc::tr (xdoc::td "@('(c::version-c17)')")
                (xdoc::td "@('-std=c17')"))
      (xdoc::tr (xdoc::td "@('(c::version-c23)')")
                (xdoc::td "@('-std=c23')"))
      (xdoc::tr (xdoc::td "@('(c::version-c17+gcc)') /
                           @('(c::version-c17+clang)')")
                (xdoc::td "@('-std=gnu17')"))
      (xdoc::tr (xdoc::td "@('(c::version-c23+gcc)') /
                           @('(c::version-c23+clang)')")
                (xdoc::td "@('-std=gnu23')")))
     (xdoc::p
      "The @(':preprocess-args') input specifies additional arguments
       to pass to the external preprocessor beyond the two outlined above.
       If @(':preprocess-args') is a string list,
       this list of arguments is passed to the preprocessor for each file,
       following the @('-E') and ('-std=') arguments.
       If @(':preprocess-args') is an omap,
       then we provide the list of arguments associated with the file name
       (again, after the @('-E') and @('-std=') arguments).
       A file in the @(':files') list corresponds to a list of arguments
       in the map only when the file name matches the map key exactly
       (i.e., without prepending the @(':base-dir')).
       If the file name is not in the key set,
       only the @('-E') and @('std=') arguments are provided.
       If @(':preprocess-args') is @('nil'),
       it is technically both a string list and
       an omap from strings to string lists;
       the behavior is the same under either interpretation:
       only the @('-E') and @('-std=') arguments are provided for each file."))

    (xdoc::desc
     "@(':include-dirs') &mdash; default @('nil')"
     (xdoc::p
      "Specifies the directories used by the internal preprocessor
       to search for files included with angle-bracket @('#include') directives
       (and with double-quote @('#include') directives
       when the file is not found relative to the including file).")
     (xdoc::p
      "This must evaluate to a list of strings,
       which should be absolute paths in the file system.")
     (xdoc::p
      "Unless @(':preprocess') is @(':internal'),
       @(':include-dirs') must evaluate to @('nil')."))

    (xdoc::desc
     "@(':process') &mdash; default @(':validate')"
     (xdoc::p
      "Specifies the processing to perform
       on the files specified by the @(':files') and @(':base-dir') inputs
       (if @(':preprocess') is @('nil'))
       or on the result of preprocessing those files
       (if @(':preprocess') is not @('nil')).")
     (xdoc::p
      "This input must be one of the following:")
     (xdoc::ul
      (xdoc::li
       "@(':parse'),
        to "
       (xdoc::seetopic "parser" "parse")
       " the files into an "
       (xdoc::seetopic "abstract-syntax" "abstract syntax")
       " representation, which may contain ambiguous constructs.")
      (xdoc::li
       "@(':disambiguate'),
        to parse the files, and then to "
       (xdoc::seetopic "disambiguator" "disambiguate")
       " the possibly ambiguous abstract syntax representation
        obtained from the parser
        into a non-ambiguous abstract syntax representation.")
      (xdoc::li
       "@(':validate') (the default),
        to parse and disambiguate the files, and then to "
       (xdoc::seetopic "validator" "validate")
       " the disambiguated abstract syntax representation
        obtained from the disambiguator,
        which annotated the abstract syntax with "
       (xdoc::seetopic "validation-information" "validation information")
       "."))
     (xdoc::p
      "These levels of processing are ordered as")
     (xdoc::codeblock
      ":parse < :disambiguate < :validate")
     (xdoc::p
      "where a larger level includes and extends
       the processing of smaller levels.
       These processing levels are orthogonal to
       the preprocessing specified by @(':preprocess'),
       since they apply equally to
       either the original or the preprocessed files."))

    (xdoc::desc
     "@(':const') &mdash; required, no default"
     (xdoc::p
      "Name of the generated ACL2 constant whose value is
       the result of processing (and possibly preprocessing)
       the files specified in the @(':files') and @(':base-dir') inputs.")
     (xdoc::p
      "If @(':process') is @(':parse'),
       the value of the constant named by @(':const') is a "
      (xdoc::seetopic "code-ensembles" "code ensemble")
      " consisting of the translation unit ensemble
       resulting from the parser,
       paired with the implementation environment
       determined by the inputs described below.
       Since the parser captures ambiguous constructs without resolving them,
       this representation may include ambiguous constructs.")
     (xdoc::p
      "If @(':process') is @(':disambiguate'),
       the value of the constant named by @(':const') is a "
      (xdoc::seetopic "code-ensembles" "code ensemble")
      " consisting of the translation unit ensemble
       resulting from the disambiguator,
       paired with the implementation environment
       determined by the inputs described below.
       This representation has no ambiguous constructs.")
     (xdoc::p
      "If @(':process') is @(':validate'),
       the value of the constant named by @(':const') is a "
      (xdoc::seetopic "code-ensembles" "code ensemble")
      " consisting of the translation unit ensemble
       resulting from the validator,
       paired with the implementation environment
       determined by the inputs described below.
       This representation has no ambiguous constructs
       and is annotated with validation information.")
     (xdoc::p
      "In all cases, the keys of the translation unit ensemble map
       are the file paths specified in the @(':files') input,
       without the @(':base-dir') prefix.")
     (xdoc::p
      "In the rest of this documentation page,
       let @('*const*') be the name of this constant."))

    (xdoc::desc
     "@(':keep-going') &mdash; default @('nil')"
     (xdoc::p
      "Boolean flag saying whether to keep going after failing to input a file.
       When @('t'), files which fail parsing, disambiguation, or validation
       are dropped and the relevant error is printed.
       Furthermore, at the end of each stage, if any file has failed,
       then the fraction of successful files is also printed.")
     (xdoc::p
      "This flag is provided primarily for debugging purposes.
       Successful validation of later files following the first failure
       may be erroneous due to the inability to perform certain cross-checks
       against the dropped files."))

    (xdoc::desc
     "@(':ienv') &mdash; default @('(ienv-default)')"
     (xdoc::p
      "Specifies the "
      (xdoc::seetopic "implementation-environments"
                      "implementation environment")
      ". This affects which standard and dialect of C used,
       and implementation details such as the size and signedness of types.")
     (xdoc::p
      "The implementation environment becomes part of the code ensemble
       that is the value of the constant @('*const*').")))

   ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

   (xdoc::evmac-section-generated

    (xdoc::desc
     "@('*const*')"
     (xdoc::p
      "The named constant containing the result of processing,
       as specified by @(':process'),
       the files specified by the @(':files') and @(':base-dir') inputs
       (if @(':preprocess') is @('nil'))
       or the files resulting from preprocessing those
       (if @(':preprocess') is not @('nil')).")
     (xdoc::p
      "This constant can be passed to @(tsee output-files)
       or to some "
      (xdoc::seetopic "c2c::transformation-tools" "transformation")
      ".")))))
