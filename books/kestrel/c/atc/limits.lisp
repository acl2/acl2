; C Library
;
; Copyright (C) 2026 Kestrel Institute (http://www.kestrel.edu)
;
; License: A 3-clause BSD license. See the LICENSE file distributed with ACL2.
;
; Author: Alessandro Coglio (www.alessandrocoglio.info)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(in-package "C")

(include-book "centaur/fty/top" :dir :system)
(include-book "std/util/defirrelevant" :dir :system)

(include-book "std/basic/controlled-configuration" :dir :system)
(acl2::controlled-configuration)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(defxdoc+ atc-limits
  :parents (atc-event-and-code-generation)
  :short "Execution limits for generated theorems."
  :long
  (xdoc::topstring
   (xdoc::p
    "Our dynamic semantics of C makes use of artificial limits
     to ensure that the execution functions always terminate;
     see @(see dynamic-semantics).
     The C code generated by ATC always terminates,
     and this is part of the proofs generated by ATC.
     The theorems say that, given a sufficiently large limit,
     the execution of the construct in question terminates.
     The sufficiently large limit depends on the construct in question,
     and is calculated from the constructs.
     The limit is not necessarily a constant:
     if loops are involved,
     the limit depends on some of the values manipulated during execution:
     so the theorems use symbolic terms for those limits.")
   (xdoc::p
    "A limit term always has the form")
   (xdoc::codeblock
    "(+ <const> <nonconst1> ... <nonconstN>)")
   (xdoc::p
    "where @('<const>') is a constant positive integer,
     and @('<nonconst1>'), ..., @('<nonconstN>') are
     zero or more non-constant terms, which involve ACL2 variables.")
   (xdoc::p
    "We introduce a data structure to represent these limit terms,
     along with operations on it."))
  :order-subtopics t
  :default-parent t)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(fty::defprod limit-term
  :short "Fixtype of limit terms."
  :long
  (xdoc::topstring
   (xdoc::p
    "As explained in @(see atc-limits),
     a limit term is the sum of
     a positive integer constant
     and zero or more non-constant terms;
     we organize the latter in a list.
     Since we use untranslated terms, the list has a generic type."))
  ((const pos)
   (nonconsts true-listp))
  :pred limit-termp)

;;;;;;;;;;;;;;;;;;;;

(defirrelevant irr-limit-term
  :short "An irrelevant limit term."
  :type limit-termp
  :body (make-limit-term :const 1 :nonconsts nil))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(define limit-term-to-term ((limterm limit-termp))
  :returns (term "An untranslated term.")
  :short "Turn a limit term into an ACL2 (untranslated) term."
  (b* (((limit-term limterm) limterm))
    (if limterm.nonconsts
        `(+ ,limterm.const ,@limterm.nonconsts)
      limterm.const)))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(define limit-term-const ((const posp))
  :returns (limterm limit-termp)
  :short "Build a limit term consisting of a constant."
  (make-limit-term :const (pos-fix const) :nonconsts nil))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(define limit-term-add ((limterm1 limit-termp) (limterm2 limit-termp))
  :returns (limterm limit-termp)
  :short "Add two limit terms."
  :long
  (xdoc::topstring
   (xdoc::p
    "We add the constants and we concatenate the non-constants."))
  (b* (((limit-term limterm1) limterm1)
       ((limit-term limterm2) limterm2))
    (make-limit-term :const (+ limterm1.const
                               limterm2.const)
                     :nonconsts (append limterm1.nonconsts
                                        limterm2.nonconsts))))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(define limit-term-add-const ((const posp) (limterm limit-termp))
  :returns (limterm1 limit-termp)
  :short "Add a constant to a limit term."
  (b* (((limit-term limterm) limterm))
    (make-limit-term :const (+ limterm.const (pos-fix const))
                     :nonconsts limterm.nonconsts)))
