; A formal model of ARM32: Instruction definition tool
;
; Copyright (C) 2025-2026 Kestrel Institute
;
; License: A 3-clause BSD license. See the file books/3BSD-mod.txt.
;
; Author: Eric Smith (eric.smith@kestrel.edu)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(in-package "ARM")

(include-book "encodings")

(defun let-bindings-for-encoding-fields (pat)
  (declare (xargs :guard (encoding-patternp pat)))
  (if (endp pat)
      nil
    (let ((item (first pat)))
      (if (or (eql 0 item)
              (eql 1 item))
          ;; constant field, so nothing to bind:
          (let-bindings-for-encoding-fields (rest pat))
        ;; item must be (<var> <numbits>):
        (let ((var (first item)))
          (cons `(,var (lookup-eq-safe ',var args))
                (let-bindings-for-encoding-fields (rest pat))))))))

(defun def-inst-fn (mnemonic body)
  (declare (xargs :guard (symbolp mnemonic)))
  (let* ((encoding-patten (lookup-eq-safe mnemonic *desugared-patterns*))
         (mnemonic-name (intern$ (symbol-name mnemonic) "ARM")) ; convert from keyword package
         (args-predicate (pack-in-package "ARM" mnemonic-name '-argsp)) ;; generated by make-decoder
         )
    (if (not (encoding-patternp encoding-patten))
        (er hard? 'def-inst-fn "Bad pattern for ~x0: ~x1." mnemonic encoding-patten)
      `(defund ,(pack-in-package "ARM" 'execute- mnemonic-name) (args arm)
         (declare (xargs :guard (and (symbol-alistp args)
                                     (,args-predicate args))
                         :guard-hints (("Goal" :in-theory (enable ,args-predicate)))
                         :stobjs arm))
         (let ,(let-bindings-for-encoding-fields encoding-patten)
           ;; todo: can we automate any of the body?:
           ,body)))))

;; The body can refer to all the field names in the encoding of the instruction.
(defmacro def-inst (mnemonic body)
  (def-inst-fn mnemonic body))
